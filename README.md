# Finik Backend Integration

Backend –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–æ–π –æ–ø–ª–∞—Ç—ã Finik.

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- Node.js 18+
- Express.js
- @mancho.devs/authorizer ‚Äî –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- node-fetch ‚Äî –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- dotenv ‚Äî –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- uuid ‚Äî –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
- PostgreSQL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
npm install
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` –≤ `.env`:
```bash
cp .env.example .env
```

2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env`:
   - `FINIK_API_KEY` ‚Äî API –∫–ª—é—á –æ—Ç Finik
   - `FINIK_ACCOUNT_ID` ‚Äî ID –∞–∫–∫–∞—É–Ω—Ç–∞
   - `FINIK_PRIVATE_KEY` ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á RSA (—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ backend!)
   - `FINIK_PUBLIC_KEY` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
   - `REDIRECT_URL` ‚Äî URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
   - `WEBHOOK_URL` ‚Äî URL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è webhook –æ—Ç Finik

## –ó–∞–ø—É—Å–∫

```bash
npm start
```

–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π:
```bash
npm run dev
```

## API Endpoints

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

**POST** `/api/payments/create`

Request body:
```json
{
  "amount": 1000
}
```

Response:
```json
{
  "paymentUrl": "https://...",
  "paymentId": "uuid"
}
```

### Webhook –æ—Ç Finik

**POST** `/api/webhooks/finik`

–≠—Ç–æ—Ç endpoint –ø—Ä–∏–Ω–∏–º–∞–µ—Ç webhook –æ—Ç Finik –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π.

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞**: –ü–ª–∞—Ç–µ–∂ —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è webhook —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `SUCCEEDED`. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `RedirectUrl` –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º.

2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: Webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å —Ç–µ–º –∂–µ `transactionId` –Ω–µ –∏–∑–º–µ–Ω—è—é—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞.

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: 
   - –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ backend
   - –í—Å–µ webhook –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –ø–æ–¥–ø–∏—Å—å
   - Webhook –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å –º–µ–Ω–µ–µ —á–µ–º –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É

4. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: 
   - –ï—Å–ª–∏ `DATABASE_URL` –Ω–µ –∑–∞–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
   - –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PostgreSQL

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
finik-backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app.js                 # Express –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ server.js              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ finik.js           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Finik
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment.routes.js  # –†–æ—É—Ç—ã –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webhook.routes.js  # –†–æ—É—Ç—ã –¥–ª—è webhook
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ finik.service.js   # –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Finik API
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ verifyWebhook.js   # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook
‚îÇ   ‚îî‚îÄ‚îÄ db/
‚îÇ       ‚îî‚îÄ‚îÄ payments.repository.js # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
‚îú‚îÄ‚îÄ .env                       # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md
```

## –î–µ–ø–ª–æ–π

üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é**: —Å–º. [DEPLOY.md](./DEPLOY.md)

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É:
```bash
ssh root@2.56.179.126
```

2. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
```bash
git clone https://github.com/isan228/test-finik.git /var/www/finik-backend
cd /var/www/finik-backend
```

3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
npm install --production
```

4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `.env` —Ñ–∞–π–ª (—Å–º. `.env.example`)

5. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PM2 –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
```bash
npm install -g pm2
pm2 start src/server.js --name finik-backend
pm2 save
pm2 startup
```

### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- ‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ `.env`
- ‚úÖ `WEBHOOK_URL` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–π URL: `http://2.56.179.126/api/webhooks/finik`
- ‚úÖ `REDIRECT_URL` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ Webhook endpoint –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –±—ã—Å—Ç—Ä–æ (< 1 —Å–µ–∫)
- ‚úÖ Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–ø–æ—Ä—Ç 80/443 –∏–ª–∏ 3000 –æ—Ç–∫—Ä—ã—Ç)

